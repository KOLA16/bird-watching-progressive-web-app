<!DOCTYPE html>
<html>

<head>
    <title>
        <%= title %>
    </title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel='stylesheet' type='text/css' href='/stylesheets/style.css' />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script type="text/JavaScript" src="https://MomentJS.com/downloads/moment-with-locales.js"></script>
    <script type="module" src="/javascripts/sightings.js"></script>
</head>

<body class="container">
<% include navbar %>

    <h1 class="mb-5">
        <%= title %>
    </h1>

    <!-- Provide username form before accessing the functionality -->
    <div id="username_form">
        <form>
            <input type="text" name="username" id="username_input" required minlength="3" maxlength="100">
            <input id="username_btn_set" type="button" value="Set Username">
        </form>
    </div>


    <!-- Table with all sightings -->
    <table class="table table-hover align-middle table-sm" id="sightings_table">
        <thead class="table-light">
            <th>Bird Sighting</th>
            <th onclick="sortTable(1, true)" class="clickable">
                Datetime
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-chevron-expand" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708zm0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708z" />
                </svg>
            </th>
            <th onclick="sortTable(2, false)" class="clickable">
                Identification
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-chevron-expand" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M3.646 9.146a.5.5 0 0 1 .708 0L8 12.793l3.646-3.647a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708zm0-2.292a.5.5 0 0 0 .708 0L8 3.207l3.646 3.647a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 0 0 0 .708z" />
                </svg>
            </th>
            <th>User</th>
        </thead>
        <% sightings.forEach((sighting, i)=> {%>
            <tr class="clickable clickable-row" data-href='/sighting?id=<%= sighting._id %>'>
                <td>
                    <img src='<%= sighting.image %>' alt='Sighting image' id='sightings_img' width="250" height="200">
                </td>
                <td>
                    <%= moment(sighting.observation_date).format('D MMM H:mm') %>
                </td>
                <td>
                    <%= sighting.identification %>
                </td>
                <td>
                    <%= sighting.user_nickname %>
                </td>
            </tr>
            <% }); %>
    </table>

<div>
    <footer>
        <p>Â© 2023 Bird Watching. All Rights Reserved.</p>
    </footer>
</div>

    <script>

        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js', { scope: '/' });
        }

        function sortTable(col_index, is_datetime) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("sightings_table");

            switching = true;
            dir = "asc";

            while (switching) {
                switching = false;
                rows = table.rows;

                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;

                    x = rows[i].getElementsByTagName("td")[col_index];
                    y = rows[i + 1].getElementsByTagName("td")[col_index];

                    if (is_datetime) {
                        x = moment(x.innerHTML, 'D MMM H:mm').toDate();
                        y = moment(y.innerHTML, 'D MMM H:mm').toDate();
                    } else {
                        x = x.innerHTML.toLowerCase()
                        y = y.innerHTML.toLowerCase()
                    }

                    if (dir == "asc") {

                        if (x > y || x === "unknown" || x === "uncertain") {
                            shouldSwitch = true;
                            break;
                        }
                    } else if (dir == "desc") {
                        if (x < y || x === "unknown" || x === "uncertain") {
                            shouldSwitch = true;
                            break;
                        }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
        }

    </script>
</body>

</html>